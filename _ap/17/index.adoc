---
num: 17
tags:
  - "tls"
  - "certificates"
  - "dns"
  - "Letsencrypt"
title: "Automatic management of certificates per data plane cluster using Letsencrypt"
status: "Accepted"
authors:
  - "Manyanda Chitimbo"
---

## Intent

Define a pattern for the automatic management of certificates per data plane cluster using Letsencrypt

## Motivation

When a managed service is deployed on the data plane cluster its routes have be reachable via TLS.
It means that a managed service deployed in the data plane has to provide a way to the clients (end users) to verify and validate the TLS connection.

## Applicability

This pattern applies to any service deployed on a dataplane that wants a managed service routes to be reachable via TLS

## Description

A managed service will use https://Letsencrypt.org[Letsencrypt] to managed certificates on the fly i.e automatic and thus removing the need for manual intervention and the toil related to this.

To avoid sharing of certificates between data planes, managed service implementors are recommended to generate a wildcard certificate per data plane.

As an example, if the root domain is `myservice.bf2.dev`, then a wildcard certificate will be generated for each data plane cluster under a subdomain `<cluster-id>.myservice.bf2.dev`. The `<cluster-id>` is the id of the data plane cluster.

Furthermore, all routes for the managed services deployed on the the data plane will be of the form `foobar.<cluster-id>.myservice.bf2.dev`.

NOTE: There is a more granular approach to avoid certificate sharing by generating a widlcard certificate per deployed service instance, however this approach is likely to encounter and hits https://Letsencrypt.org/docs/rate-limits/[Letsencrypt limits] more frequently. 

An example of this pattern in use can be seen in link:../../adr/89[ADR-89].

## Participants

* Control Plane -- knows all the data plane and request the certificate for each data plane from Certificate Authority.
* Data Plane -- where the managed instances are deployed. This is where the certificates will be passed down to via the CR and it is where the certificate resides in form of a Kubernetes secret.
* Letsencrypt -- Certificate authority where the certificate is issued.
* Vault - a secure storage for the generated certificates.

## Consequences

What this pattern brings:

* Automated management of certificates per data plane cluster.
* Avoid sharing of certificate per data plane cluster and if one data plane cluster is compromised, the rest of the data plane are not affected
* Consistency with other services which also apply this AP

However there are challenges that service implementors have to be aware of:

* Once the certificates are generated, the managed service have to secure storing of the auto generated certificate in Vault and ensuring that only priveledged users e.g only SRE, have access to Vault.
* Once the certificates in the Data Plane, they should be in a Kubernetes secret that only priveldged users can see. 
* Reaching the various advertised https://Letsencrypt.org/docs/rate-limits/[Letsencrypt limits] is also a challenge.
However, the various limits once reached can be overridden via a request as described in https://Letsencrypt.org/docs/rate-limits/#a-id-overrides-a-overrides[Letsencrypt limits overrides]
