<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Canary Authentication in RHOSAK | Application Services Architecture</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Canary Authentication in RHOSAK" />
<meta name="author" content="Rajagopalan Ranganathan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Context and Problem Statement" />
<meta property="og:description" content="Context and Problem Statement" />
<link rel="canonical" href="https://architecture.bf2.dev/adr/86/" />
<meta property="og:url" content="https://architecture.bf2.dev/adr/86/" />
<meta property="og:site_name" content="Application Services Architecture" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-17T14:56:12+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Canary Authentication in RHOSAK" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Rajagopalan Ranganathan"},"dateModified":"2023-04-17T14:56:12+00:00","datePublished":"2023-04-17T14:56:12+00:00","description":"Context and Problem Statement","headline":"Canary Authentication in RHOSAK","mainEntityOfPage":{"@type":"WebPage","@id":"https://architecture.bf2.dev/adr/86/"},"url":"https://architecture.bf2.dev/adr/86/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://architecture.bf2.dev/feed.xml" title="Application Services Architecture" /></head>
<body><link rel="icon" type="image/png" href="/favicon.png">
<header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Application Services Architecture</a>


    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a class="page-link" href="/about/">About</a>
        <a class="page-link" href="/overview/">Overview</a>
        <a class="page-link" href="/context/">Context</a>
        <a class="page-link" href="/padr/">PADRs</a>
        <a class="page-link" href="/adr/">ADRs</a>
        <a class="page-link" href="/ap/">APs</a>
        <a class="page-link" href="/glossary/">Glossary</a>
        <!-- <a class="page-link" href="/component/">Components</a> -->
      </div>
    </nav></div>
</header>
<div class="wrapper">
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <link rel="stylesheet" href="/css/adr.css">
<article class="post">

  <!-- <header class="post-header">
    <h1 class="post-title">Canary Authentication in RHOSAK</h1>
  </header> -->

  <div class="post-content">
    <article class="post">
  <header class="post-header">
    <h1 class="post-title">ADR-86: Canary Authentication in RHOSAK</h1>
  </header>

  <div>
    <div>Status: <span class="status-draft">Draft</span>
    
    </div>
    <div>Authors:
      
      
      
      
      Rajagopalan Ranganathan
      
    </div>
    
    <div>Tags: 
      
      <span class="tag tag-kafka">kafka</span>
      
      <span class="tag tag-Canary">Canary</span>
      
      <span class="tag tag-Authentication">Authentication</span>
      
    </div>
    
    
  </div>

  <div class="post-content">
    <div class="post-toc">
      <h2>Contents</h2>
      <ul class="sectlevel1">
<li><a href="#context-and-problem-statement">Context and Problem Statement</a></li>
<li><a href="#goals">Goals</a></li>
<li><a href="#non-goals">Non-goals</a></li>
<li><a href="#current-architecture">Current architecture</a></li>
<li><a href="#proposed-architecture">Proposed architecture</a>
<ul class="sectlevel2">
<li><a href="#threat-model">Threat model</a></li>
</ul>
</li>
<li><a href="#alternatives-considered-rejected">Alternatives Considered / Rejected</a></li>
<li><a href="#challenges">Challenges</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#consequences-if-not-completed">Consequences if not completed</a></li>
</ul>
    </div>
    
    <div class="sect1">
<h2 id="context-and-problem-statement">Context and Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Canary tool is responsible to establish the health of the Kafka cluster. To learn more about the Strimzi Canary tool used in Kafka clusters,
please refer <a href="https://github.com/strimzi/strimzi-canary">here</a> .</p>
</div>
<div class="paragraph">
<p>Strimzi canary currently uses SASL/Plain (Simple Authentication and Security Layer - SASL) authentication mechanism in our Red Hat OpenShift Streams for Apache Kafka (RHOSAK) environment. Managed Application Services Single Sign On (MAS SSO) is used as the authentication service. As a part of the MAS SSO to sso.redhat.com migration, the existing Canary authentication mechanism will undergo some changes.</p>
</div>
<div class="paragraph">
<p>The purpose of this ADR is to detail the existing authentication flow using MAS SSO and the authentication changes post migration to sso.redhat.com</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="goals">Goals</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Secure Strimzi Canary authentication with sso.redhat.com</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="non-goals">Non-goals</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="current-architecture">Current architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Currently, Kas Fleet Manager (KFM) creates a Canary service account client in MAS SSO upon a request to create and provision a Kafka cluster. These Canary service account clients are associated with the same organization as the user making the request to create a Kafka cluster. This information is contained in the <code>customClaimCheck</code> field in the Kafka Custom Resource (CR)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   - authentication:
      customClaimCheck: '@.rh-org-id == ''testorgid''|| @.org_id == ''testorgid'''
      tokenEndpointUri: &gt;-
            https://tokenendpointauri.com/token
       ...
    serviceAccounts:
    - name: canary
      password: **********
      principal: canary-client-Id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Strimzi Canary uses SASL/Plain authentication mechanism with the Kafka broker. Control plane i.e. KFM provides a canary service account client ID and secret in the Managed Kafka Custom Resource (CR) along with a Token Endpoint URI (Uniform Resource Identifier). Canary uses this information to authenticate with the Kafka brokers using SASL/Plain authentication mechanism, i.e. similar to username and password. Canary provides the client ID and secret as a part of its authentication request to the Kafka Broker. Kafka broker uses this information to authenticate with the service mentioned in the token endpoint URI. Currently, this token end point URI is configured to be the MAS SSO service.</p>
</div>
<div class="paragraph">
<p>Upon a successful authentication, MAS SSO provides a valid token back to the Kafka broker. Kafka brokers as a part of its authentication flow, upon a successful response, it introspects the token received and performs a custom claims check. It verifies that the "Canary Service account Client" belongs to the same organization as the creator or owner of the Kafka instance. Kafka brokers deem the authentication to be successful after this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="adr-86-current-authentication-flow.png" alt="Current authenticaion flow">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="proposed-architecture">Proposed architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using sso.redhat.com as the single authentication post migration, KFM will create the Canary Service Account Clients in a "Special Management Organization". This would mean all the internal service accounts such as the Canary for all users (for all organizations) are created in this single organization that is managed and owned by Red hat. The reasons for this are, the limit on the number of service accounts an organization can create do not apply for this organization, and it provides more security by restricting these internal service accounts to the organization that is owned by red hat rather than the customer&#8217;s organization.</p>
</div>
<div class="paragraph">
<p>This would mean that all the Canary service accounts for all customers/users will be created/associated with this "Special Management Organization" when compared to the existing architecture where they were scoped to the user&#8217;s organization. This requires some additional steps in authentical flow described in the current architecture section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>KFM when building the "CustomClaimCheck" includes the  Canary service account client ID "clientID" field as well</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   - authentication:
      customClaimCheck: '@.rh-org-id == ''testorgid''|| @.org_id == ''testorgid'' || @.clientId == ''canary-client-Id'''
      tokenEndpointUri: &gt;-
            https://tokenendpointuri.com/token
       ...
    serviceAccounts:
    - name: canary
      password: **********
      principal: canary-client-Id</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Token Endpoint URI would now point to sso.redhat.com</p>
</li>
<li>
<p>The existing authentication flow up until receiving a valid token from the service mentioned in Token end point URI continues as it is.</p>
</li>
<li>
<p>During the Token introspection and performing the custom claim check validation, the following will be done:</p>
</li>
<li>
<p>Verify that the "ClientID" in the custom claim check matches the expected Canary client ID</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="adr-86-proposed-authentication-flow.png" alt="Proposed authenticaion flow">
</div>
</div>
<div class="sect2">
<h3 id="threat-model">Threat model</h3>
<div class="paragraph">
<p>All the internal service accounts post migration to sso.redhat.com will be created under a single "Special Management Org" rather than the user&#8217;s organization. This increases the threat landscape of a compromised Canary Service Account, i.e. the Canary Service Account for a Kafka cluster belonging to an Organization "A" can in theory be used against a Kafka cluster belonging to organization "B".</p>
</div>
<div class="paragraph">
<p>To mitigate this threat, we have provided a solution to add the "ClientID" as well in the "customClaimCheck" field. This would enforce that
the Kafka brokers only authenticate with the "Canary service account client" that is provided by the control plane pertaining for that particular Kafka cluster.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="alternatives-considered-rejected">Alternatives Considered / Rejected</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="challenges">Challenges</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="dependencies">Dependencies</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="consequences-if-not-completed">Consequences if not completed</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Canary authentication will fail and health of the Kafka clusters cannot be determined</p>
</li>
</ul>
</div>
</div>
</div>  
  </div>

</article>
  
  </div>

</article>

      </div>
    </main><div class="edit">
  <a href="https://github.com/bf2fc6cc711aee1a0c2a/architecture/edit/main/_adr/86/index.adoc">✎ Edit this page</a>
</div>
</div>
<footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Application Services Architecture</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Application Services Architecture</li><li><a class="u-email" href="mailto:mk-support@redhat.com">mk-support@redhat.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div> 

      <div class="footer-col footer-col-3">
        <p>This site contains resources about the architecture and processes for Red Hat Application Services.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
