<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Handling usage of dynamically-async-created DNS records from dependent services | Application Services Architecture</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Handling usage of dynamically-async-created DNS records from dependent services" />
<meta name="author" content="Gerard Ryan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This site contains resources about the architecture and processes for Red Hat Application Services." />
<meta property="og:description" content="This site contains resources about the architecture and processes for Red Hat Application Services." />
<link rel="canonical" href="https://architecture.bf2.dev/adr/76/" />
<meta property="og:url" content="https://architecture.bf2.dev/adr/76/" />
<meta property="og:site_name" content="Application Services Architecture" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-17T14:56:12+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Handling usage of dynamically-async-created DNS records from dependent services" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Gerard Ryan"},"dateModified":"2023-04-17T14:56:12+00:00","datePublished":"2023-04-17T14:56:12+00:00","description":"This site contains resources about the architecture and processes for Red Hat Application Services.","headline":"Handling usage of dynamically-async-created DNS records from dependent services","mainEntityOfPage":{"@type":"WebPage","@id":"https://architecture.bf2.dev/adr/76/"},"url":"https://architecture.bf2.dev/adr/76/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://architecture.bf2.dev/feed.xml" title="Application Services Architecture" /></head>
<body><link rel="icon" type="image/png" href="/favicon.png">
<header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Application Services Architecture</a>


    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a class="page-link" href="/about/">About</a>
        <a class="page-link" href="/overview/">Overview</a>
        <a class="page-link" href="/context/">Context</a>
        <a class="page-link" href="/padr/">PADRs</a>
        <a class="page-link" href="/adr/">ADRs</a>
        <a class="page-link" href="/ap/">APs</a>
        <a class="page-link" href="/glossary/">Glossary</a>
        <!-- <a class="page-link" href="/component/">Components</a> -->
      </div>
    </nav></div>
</header>
<div class="wrapper">
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <link rel="stylesheet" href="/css/adr.css">
<article class="post">

  <!-- <header class="post-header">
    <h1 class="post-title">Handling usage of dynamically-async-created DNS records from dependent services</h1>
  </header> -->

  <div class="post-content">
    <article class="post">
  <header class="post-header">
    <h1 class="post-title">ADR-76: Handling usage of dynamically-async-created DNS records from dependent services</h1>
  </header>

  <div>
    <div>Status: <span class="status-accepted">Accepted</span>
    
    </div>
    <div>Authors:
      
      
      
      
      Gerard Ryan
      
    </div>
    
    <div>Tags: 
      
      <span class="tag tag-kafka">kafka</span>
      
    </div>
    
    
  </div>

  <div class="post-content">
    <div class="post-toc">
      <h2>Contents</h2>
      <ul class="sectlevel1">
<li><a href="#context-and-problem-statement">Context and Problem Statement</a></li>
<li><a href="#goals">Goals</a></li>
<li><a href="#current-situation">Current situation</a>
<ul class="sectlevel2">
<li><a href="#rhosak"><abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr></a></li>
</ul>
</li>
<li><a href="#proposal">Proposal</a>
<ul class="sectlevel2">
<li><a href="#rhosak-2"><abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr></a></li>
<li><a href="#threat-model">Threat model</a></li>
</ul>
</li>
<li><a href="#alternatives-considered-rejected">Alternatives Considered / Rejected</a></li>
<li><a href="#challenges">Challenges</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#consequences-if-not-completed">Consequences if not completed</a></li>
</ul>
    </div>
    
    <div class="sect1">
<h2 id="context-and-problem-statement">Context and Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For some services (such as <abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr>), when a new instance is being created for a customer, we create new cluster-agnostic DNS records in Route53 via the control plane, pointing to resources that the customer needs access to.
We also use those customer-facing domains to monitor availability (such as via the Strimzi Canary in the <abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr> case).</p>
</div>
<div class="paragraph">
<p>The problem is that the data plane components process may start continuously trying to connect the domain for a period of time before the domain has been created.
This can lead to an issue called “negative DNS caching”, where DNS resolvers, between the querying process and the authoritative DNS servers for the domain, cache the non-existence of the domain for a few minutes.
This can lead to a longer lead time to the monitoring process reporting availability metrics.
If there’s a load-balanced caching DNS resolver setup involved, then some of them may negatively cache, but not others.
This can lead to the additional problem where the domain eventually exists, and a DNS server replica that hasn’t negatively cached is hit and gives a successful response, but then after the TTL expires, another lookup is performed and hits one that is still negatively caching, then it can appear as though the service has become unavailable after initially being available.</p>
</div>
<div class="paragraph">
<p>If a service (such as <abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr>) is affected by this problem and does not address it, then it could affect any availability SLO reporting, and could also cause alerts to fire unnecessarily, causing unhappy SREs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="goals">Goals</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Improve availability monitoring by preventing negative DNS caching.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="current-situation">Current situation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="rhosak"><abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr></h3>
<div class="ulist">
<ul>
<li>
<p>Fleetshard operator in data plane decides what domains are needed, and passes the list back to fleet manager in the control plane, which creates the required records in AWS Route 53 (as described in <a href="../57/index.html">ADR-57</a>).</p>
</li>
<li>
<p>Fleetshard operator provisions the Kafka instance, including the component that needs to dial the external address.</p>
</li>
<li>
<p>The component that needs to dial the external address starts trying to connect to the dependent service using the external address</p>
<div class="ulist">
<ul>
<li>
<p>The DNS lookups of the external address domain will fail continuously until the domain exists.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="proposal">Proposal</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="rhosak-2"><abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr></h3>
<div class="ulist">
<ul>
<li>
<p>Fleetshard operator in data plane decides what domains are needed, and passes the list back to fleet manager in the control plane, which creates the required records in AWS Route 53 (as described in <a href="../57/index.html">ADR-57</a>).</p>
</li>
<li>
<p>Fleetshard operator provisions the Kafka instance including the component that needs to lookup the external address.
The component itself is responsible for determining the authoritative DNS server for the external domain, and querying it for the domain in question periodically, until it indicates that the domain exists.
This logic could be in the component’s initialization routine, or a script in an init container on the pod, or any other such approach.
It’s suggested to log or expose metrics on the number of failed lookups for a host over time, as it could be useful for troubleshooting.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For our development clusters, for <abbr title="Red Hat OpenShift Streams for Apache Kafka">RHOSAK</abbr> at least, we use OSD clusters on AWS, and we use subdomains on the cluster domain for the external address, rather than CNAMEs created asynchronously.
These OSD clusters use split DNS, using two hosted zones in Route53, one public and one private.
When the component tries to query the subdomain using the authoritative DNS server on the internal zone (it gets this because it’s querying from within the cluster), then it will get a REFUSED answer.
In this case, either the authoritative DNS server will need to be determined from the external zone (or passed in), or the lookup wait behaviour should be inhibited somehow.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="threat-model">Threat model</h3>
<div class="paragraph">
<p>No threat model changes are expected here.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="alternatives-considered-rejected">Alternatives Considered / Rejected</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>It was considered to get the control plane to inform the data plane when the domains have been created so that it could delay the creation of the canary deployment until ready.
This would cause a more complex interaction between the control plane and data plane to get to the initial ready state, so it was rejected for the time being, in favour of the simpler approach detailed in this ADR.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="challenges">Challenges</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Development clusters use cluster-specific route domains, rather than CNAME records like stage/prod.
OSD clusters are configured with split DNS, using two hosted zones in Route 53, one private and one public.
In this case, when trying to determine an authoritative DNS server for the bootstrap domain, one from the internal zone will be returned.
For some reason, these refuse lookup requests from the pod. For this reason, the init container will not be added for development clusters.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dependencies">Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>N/A</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="consequences-if-not-completed">Consequences if not completed</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Canary metrics will continue to sometimes report that the Kafka instance is unavailable for a few minutes after it is ready, causing:</p>
<div class="ulist">
<ul>
<li>
<p>Critical alerts to fire, paging SREs</p>
</li>
<li>
<p>Data plane SLO dashboards to report degraded performance against the SLO</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>  
  </div>

</article>
  
  </div>

</article>

      </div>
    </main><div class="edit">
  <a href="https://github.com/bf2fc6cc711aee1a0c2a/architecture/edit/main/_adr/76/index.adoc">✎ Edit this page</a>
</div>
</div>
<footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Application Services Architecture</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Application Services Architecture</li><li><a class="u-email" href="mailto:mk-support@redhat.com">mk-support@redhat.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div> 

      <div class="footer-col footer-col-3">
        <p>This site contains resources about the architecture and processes for Red Hat Application Services.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
